<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Order</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- favicon -->
        <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico">
        <!-- Place favicon.ico in the root directory -->
        <!-- Google Fonts -->
		<link href='https://fonts.loli.net/css?family=Poppins:400,700,600,500,300' rel='stylesheet' type='text/css'>
		<!-- style css -->
		<link rel="stylesheet" href="style.css">
		<link rel="stylesheet" href="../libs/layui/css/layer.css">
		<!-- modernizr css -->
        <script src="js/vendor/modernizr-2.8.3.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <!-- Add your site or application content here -->
        <!--Header Area Start-->
        <div class="header-area">
            <div class="container">
                <div class="row">
                    <div class="col-md-2 col-sm-6 col-xs-6">
                        <div class="header-logo">
                            <a href="index.html">
                                <img src="img/logo.png" alt="">
                            </a>
                        </div>
                    </div>
                    <div class="col-md-1 col-sm-6 visible-sm  col-xs-6">
                        <div class="header-right">
                            <ul>
                                <li>
                                    <a href="my-account.html"><i class="flaticon-people"></i></a>
                                </li>
                                <li class="shoping-cart">
                                    <a href="javascript:;">
                                        <i class="flaticon-shop"></i>
                                        <span>2</span>
                                    </a>
                                    <div class="add-to-cart-product">
                                        <div class="cart-product">
                                            <div class="cart-product-image">
                                                <a href="single-product.html">
                                                    <img src="img/shop/1.jpg" alt="">
                                                </a>
                                            </div>
                                            <div class="cart-product-info">
                                                <p>
                                                    <span>1</span>
                                                    x
                                                    <a href="single-product.html">East of eden</a>
                                                </p>
                                                <a href="single-product.html">S, Orange</a>
                                                <span class="cart-price">$ 140.00</span>
                                            </div>
                                            <div class="cart-product-remove">
                                                <i class="fa fa-times"></i>
                                            </div>
                                        </div>
                                        <div class="cart-product">
                                            <div class="cart-product-image">
                                                <a href="single-product.html">
                                                    <img src="img/shop/1.jpg" alt="">
                                                </a>
                                            </div>
                                            <div class="cart-product-info">
                                                <p>
                                                    <span>1</span>
                                                    x
                                                    <a href="single-product.html">East of eden</a>
                                                </p>
                                                <a href="single-product.html">S, Orange</a>
                                                <span class="cart-price">$ 140.00</span>
                                            </div>
                                            <div class="cart-product-remove">
                                                <i class="fa fa-times"></i>
                                            </div>
                                        </div>
                                        <div class="total-cart-price">
                                            <div class="cart-product-line fast-line">
                                                <span>Shipping</span>
                                                <span class="free-shiping">$10.50</span>
                                            </div>
                                            <div class="cart-product-line">
                                                <span>Total</span>
                                                <span class="total">$ 140.00</span>
                                            </div>
                                        </div>
                                        <div class="cart-checkout">
                                            <a href="checkout.html">
                                                Check out
                                                <i class="fa fa-chevron-right"></i>
                                            </a>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>                    
                    <div class="col-md-9 col-sm-12 hidden-xs">
                        <div class="mainmenu text-center">
                            <nav>
                                <ul id="nav">
                                    <li><a href="index.html">首页</a></li>
                                    <li><a href="shop.html">精选</a></li>
                                    <li><a href="cart.html">购物车</a></li>
                                    <li><a href="order.html">订单</a></li>
                                    <li><a href="javascript:;">更多</a>
                                        <ul class="sub-menu">
                                            <li><a href="about.html">About Us</a></li>
                                            <li><a href="cart.html">Cart Page</a></li>
                                            <li><a href="checkout.html">Check Out</a></li>
                                            <li><a href="contact.html">Contact</a></li>
                                            <li><a href="my-account.html">My Account</a></li>
                                            <li><a href="shop.html">Shopping Page</a></li>
                                            <li><a href="single-product.html">Single Shop Page</a></li>
                                            <li><a href="wishlist.html">Wishlist Page</a></li>
                                    		<li><a href="login.html" class="isLogin">登录</a></li>
                                            <li><a href="javascript:;" class="isLogout" onClick="logout()">退出</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </nav>
                        </div>                        
                    </div>
                    <div class="col-md-1 hidden-sm">
                        <div class="header-right">
                            <ul>
                                <li>
                                    <a href="my-account.html"><i class="flaticon-people"></i></a>
                                </li>
                                <li class="shoping-cart">
                                    <a href="cart.html" id="shopping-cart-num">
                                        <i class="flaticon-shop"></i>
                                        <!-- 显示购物车商品商量 -->
                                    </a>
                                    <div class="add-to-cart-product">
                                        <!-- 购物车商品展示 -->
                                    	<div class="shopping-cart-book-area">
                                    	</div>
                                        <div class="total-cart-price">
                                            <div class="cart-product-line fast-line">
                                                <span>运费</span>
                                                <span class="free-shiping">￥0</span>
                                            </div>
                                            <div class="cart-product-line">
                                                <span>合计</span>
                                                <span class="total total-amount"></span>
                                            </div>
                                        </div>
                                        <div class="cart-checkout">
                                            <a href="checkout.html">
                                                去结算
                                                <i class="fa fa-chevron-right"></i>
                                            </a>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--Header Area End-->
		<!-- Mobile Menu Start -->
		<div class="mobile-menu-area">
			<div class="container">
				<div class="row">
					<div class="col-lg-12 col-md-12 col-sm-12">
						<div class="mobile-menu">
							<nav id="dropdown">
								<ul>
                                    <li><a href="index.html">HOME</a></li>
                                    <li><a href="shop.html">FEATURED</a></li>
                                    <li><a href="shop.html">REVIEW BOOK</a></li>
                                    <li><a href="about.html">ABOUT AUTHOR</a></li>
                                    <li><a href="javascript:;">pages</a>
                                        <ul>
                                            <li><a href="about.html">About Us</a></li>
                                            <li><a href="cart.html">Cart Page</a></li>
                                            <li><a href="checkout.html">Check Out</a></li>
                                            <li><a href="contact.html">Contact</a></li>
                                            <li><a href="login.html">Login</a></li>
                                            <li><a href="my-account.html">My Account</a></li>
                                            <li><a href="shop.html">Shopping Page</a></li>
                                            <li><a href="single-product.html">Single Shop Page</a></li>
                                            <li><a href="wishlist.html">Wishlist Page</a></li>
                                            <li><a href="404.html">404 Page</a></li>
                                        </ul>
                                    </li>
                                    <li><a href="contact.html">CONTACT</a></li>
								</ul>
							</nav>
						</div>
					</div>
				</div>
			</div>
		</div>		
		<!-- Mobile Menu End -->   
        <!-- Breadcrumbs Area Start -->
        <div class="breadcrumbs-area">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
					    <div class="breadcrumbs">
					       <h2>Order</h2> 
					       <ul class="breadcrumbs-list">
						        <li>
						            <a title="Return to Home" href="index.html">Home</a>
						        </li>
						        <li>Order</li>
						    </ul>
					    </div>
					</div>
				</div>
			</div>
		</div> 
		<!-- Breadcrumbs Area Start --> 
		<!-- Order Area Start -->
		<div class="shopping-cart-area section-padding">
		    <div class="container">
		        <div class="row">
		            <div class="col-md-12">
                        <div class="wishlist-table-area table-responsive">
                            <table>
                                <thead>
                                    <tr>
										<th class="product-order-id">订单号</th>
                                        <th class="product-image">封面</th>
                                        <th class="t-product-name">书名</th>
                                        <th class="product-unit-price">单价</th>
                                        <th class="product-quantity">数量</th>
                                        <th class="product-amount">小计</th>
										<th class="product-total-amount">总金额</th>
										<th class="product-status">状态</th>
										<th class="product-remove">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="orderlist">
                                    <!-- 订单tr信息 -->
                                </tbody>
                            </table>
                        </div>	
                        <div class="shopingcart-bottom-area">
                            <a class="left-shoping-cart" href="shop.html">返回购物</a>
                        </div>	                
		            </div>
		        </div>
		    </div>
		</div>
		<!-- Order Area End -->
		<!-- Footer Area Start -->
		<footer>
		    <div class="footer-top-area">
		        <div class="container">
		            <div class="row">
		                <div class="col-md-3 col-sm-8">
		                    <div class="footer-left">
		                        <a href="index.html">
		                            <img src="img/logo-2.png" alt="">
		                        </a>
		                        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore.</p>
		                        <ul class="footer-contact">
		                            <li>
		                                <i class="flaticon-location"></i>
		                                450 fifth Avenue, 34th floor. NYC
		                            </li>
		                            <li>
		                                <i class="flaticon-technology"></i>
		                                (+800) 123 4567 890
		                            </li>
		                            <li>
		                                <i class="flaticon-web"></i>
		                                info@bookstore.com
		                            </li>
		                        </ul>
		                    </div>
		                </div>
		                <div class="col-md-2 col-sm-4">
		                    <div class="single-footer">
		                        <h2 class="footer-title">Information</h2>
		                        <ul class="footer-list">
		                            <li><a href="about.html">About Us</a></li>
		                            <li><a href="javascript:;">Delivery Information</a></li>
		                            <li><a href="javascript:;">Privacy & Policy</a></li>
		                            <li><a href="javascript:;">Terms & Conditions</a></li>
		                            <li><a href="javascript:;">Manufactures</a></li>
		                        </ul>
		                    </div>
		                </div>
		                <div class="col-md-2 hidden-sm">
		                    <div class="single-footer">
		                        <h2 class="footer-title">My Account</h2>
		                        <ul class="footer-list">
		                            <li><a href="my-account.html">My Account</a></li>
		                            <li><a href="login.html">Login</a></li>
		                            <li><a href="cart.html">My Cart</a></li>
		                            <li><a href="wishlist.html">Wishlist</a></li>
		                            <li><a href="checkout.html">Checkout</a></li>
		                        </ul>
		                    </div>
		                </div>
		                <div class="col-md-2 hidden-sm">
		                    <div class="single-footer">
		                        <h2 class="footer-title">Shop</h2>
		                        <ul class="footer-list">
		                            <li><a href="javascript:;">Orders & Returns</a></li>
		                            <li><a href="javascript:;">Search Terms</a></li>
		                            <li><a href="javascript:;">Advance Search</a></li>
		                            <li><a href="javascript:;">Affiliates</a></li>
		                            <li><a href="javascript:;">Group Sales</a></li>
		                        </ul>
		                    </div>
		                </div>
		                <div class="col-md-3 col-sm-8">
		                    <div class="single-footer footer-newsletter">
		                        <h2 class="footer-title">Our Newsletter</h2>
		                        <p>Consectetur adipisicing elit se do eiusm od tempor incididunt ut labore et dolore magnas aliqua.</p>
		                        <div>
		                            <div>
		                                <input type="text" placeholder="email address">
		                            </div>
		                            <button class="btn btn-search btn-small">SUBSCRIBE</button>
		                            <i class="flaticon-networking"></i>
		                        </div>
		                        <ul class="social-icon">
		                            <li>
		                                <a href="javascript:;">
		                                    <i class="flaticon-social"></i>
		                                </a>
		                            </li>
		                            <li>
		                                <a href="javascript:;">
		                                    <i class="flaticon-social-1"></i>
		                                </a>
		                            </li>
		                            <li>
		                                <a href="javascript:;">
		                                    <i class="flaticon-social-2"></i>
		                                </a>
		                            </li>
		                            <li>
		                                <a href="javascript:;">
		                                    <i class="flaticon-video"></i>
		                                </a>
		                            </li>
		                        </ul>
		                    </div>
		                </div>
		                <div class="col-md-2 col-sm-4 visible-sm">
		                    <div class="single-footer">
		                        <h2 class="footer-title">Shop</h2>
		                        <ul class="footer-list">
		                            <li><a href="javascript:;">Orders & Returns</a></li>
		                            <li><a href="javascript:;">Search Terms</a></li>
		                            <li><a href="javascript:;">Advance Search</a></li>
		                            <li><a href="javascript:;">Affiliates</a></li>
		                            <li><a href="javascript:;">Group Sales</a></li>
		                        </ul>
		                    </div>
		                </div>
		            </div>
		        </div>
		    </div>
		    <div class="footer-bottom">
		        <div class="container">
		            <div class="row">
		                <div class="col-md-6">
                            <div class="footer-bottom-left pull-left">
                                <p>Copyright &copy; 2016 <span><a href="javascript:;">8m2</a></span>. All Right Reserved.</p>
                            </div>
		                </div>
		                <div class="col-md-6">
		                    <div class="footer-bottom-right pull-right">
		                        <img src="img/paypal.png" alt="">
		                    </div>
		                </div>
		            </div>
		        </div>
		    </div>
		</footer>
		<!-- Footer Area End -->
		<!-- all js here -->
		<!-- jquery latest version -->
        <script src="js/vendor/jquery-1.12.0.min.js"></script>
		<!-- bootstrap js -->
        <script src="js/bootstrap.min.js"></script>
		<!-- owl.carousel js -->
        <script src="js/owl.carousel.min.js"></script>
		<!-- jquery-ui js -->
        <script src="js/jquery-ui.min.js"></script>
		<!-- jquery Counterup js -->
        <script src="js/jquery.counterup.min.js"></script>
        <script src="js/waypoints.min.js"></script>	
		<!-- jquery countdown js -->
        <script src="js/jquery.countdown.min.js"></script>
		<!-- jquery countdown js -->
        <script type="text/javascript" src="venobox/venobox.min.js"></script>
		<!-- jquery Meanmenu js -->
        <script src="js/jquery.meanmenu.js"></script>
		<!-- wow js -->
        <script src="js/wow.min.js"></script>	
		<script>
			new WOW().init();
		</script>
		<!-- scrollUp JS -->		
        <script src="js/jquery.scrollUp.min.js"></script>
		<!-- plugins js -->
        <script src="js/plugins.js"></script>
		<!-- Nivo slider js -->
		<script src="lib/js/jquery.nivo.slider.js" type="text/javascript"></script>
		<script src="lib/home.js" type="text/javascript"></script>
		<!-- main js -->
        <script src="js/main.js"></script>
		<script src="../libs/layui/layer.js"></script>
		<script type="text/javascript" src="../js/app.js"></script>
		<script>
			var userToken = window.localStorage.getItem('userToken')
			initOrder()
			checkCart()
			
			// 显示登录退出标签
			showIsLogout()
			function showIsLogout() {
				if (userToken) {
					$('.isLogout').show()
					$('.isLogin').hide()
				} else {
					$('.isLogout').hide()
					$('.isLogin').show()
				}
			}
			
			function logout() {
				$.ajax({
					url: url.user.logout,
					headers: {
						token: userToken
					},
					type: 'GET',
					dataType: 'json',
					success: function(resp) {
						console.log(resp)
						window.localStorage.removeItem('userToken')
						window.location.href = 'login.html'
					}
				})
			}
			
			/**
			 * 显示用户订单
			 */
			function initOrder() {
				if (userToken == null) {
					layer.msg('会话失效，请重新登录', function() {
						window.localStorage.removeItem('userToken')
						window.location.href = 'login.html'
					}, {time: 2000})
					return false
				}
				$.ajax({
					url: url.order.getByUser,
					headers: {token: userToken},
					type: "GET",
					dataType: 'json',
					success: function(resp) {
						if (resp.code != null && resp.code == 200 && resp.data != null) {
							var html = ''
							$.each(resp.data, function(i, v) {
								html +=
									'<tr>' +
										'<td class="product-order-id">' +
											'<span>' + v.orderNo + '</span>' +
											'<input type="hidden" class="orderNo" value="' + v.orderNo + '" />' +
										'</td>' +
									    '<td class="product-image">' +
									        '<a href="javascript:;">' +
									            '<img src="' + v.book.picUrl + '" alt="" style="height: 160px;">' +
									        '</a>' +
									    '</td>' +
									    '<td class="t-product-name">' +
									        '<h3>' +
									            '<a href="javascript:;">' + v.book.name + '</a>' +
									        '</h3>' +
									    '</td>' +
									    '<td class="product-unit-price">' +
									        '<p>￥&nbsp;<span class="td-sellingPrice">' + v.book.sellingPrice + '</span></p>' +
									    '</td>' +
									    '<td class="product-quantity">' +
											'<span class="td-quantity">' + v.quantity + '</span>' +
										'</td>' +
									    '<td class="product-amount">' +
											'<p>￥&nbsp;<span class="td-amount">' + v.amount + '</span></p>' +
										'</td>' +
										'<td class="product-quantity">' +
											'<p>￥&nbsp;<span class="td-amount">' + v.totalAmount + '</span></p>' +
										'</td>' +
										'<td class="product-status">' +
											'<span class="td-status">' + v.orderStatus + '</span>' +
										'</td>' +
										'<td class="product-remove">' +
										    '<a href="javascript:;" onClick="removeTrAndProduct(this)">' +
										        '<i class="flaticon-delete"></i>' +
										    '</a>';
									if (v.status === 2) {
										html += 
										'<div class="availability">' +
											'<span><a href="javascript:;" onClick="receipt(this)">确认收货</span>' +
										'</div>';
									}
									html += '</td>' +
									'</tr>';
								$('#orderlist').html(html)
							})
						} else if (resp.code == 20000 || resp.code == 20012) {
							layer.msg(resp.msg, function() {
								window.localStorage.removeItem('userToken')
								window.location.href = 'login.html'
							}, {time: 2000})
							return false
						} else {
							layer.msg(resp.msg)
						}
					},
					error: function(e) {
						if (e.responseJSON != null) {
							layer.msg(e.responseJSON.msg)
						} else {
							layer.msg('服务器未启动')
						}
					}
				})
			}
			
			/**
			 * 查看购物车
			 */
			function checkCart() {
				if (userToken == null) return
				var html = ''
				if (userToken != null) {
					$.ajax({
						url: url.cart.get,
						headers: {
							token: userToken
						},
						type: 'GET',
						dataType: 'json',
						success: function(resp) {
							if (resp.code != null && resp.code == 200 && resp.data != null) {
								$('.shopping-cart-book-area').empty()
								var shopping_cart_num = 0
								var total_amount = 0
								$.each(resp.data, function(i, v) {
									shopping_cart_num++
									total_amount += v.amount * 10000
									html += 
										'<div class="cart-product">' +
											'<div class="cart-product-image">' +
										        '<a href="single-product.html?id=' + v.bookId + '">' +
										            '<img src="' + v.book.picUrl + '" alt="" style="max-height: 100px;">' +
										        '</a>' +
										    '</div>' +
										    '<div class="cart-product-info">' +
										        '<p>' +
										            '<span>' + v.quantity + '</span>' +
										            'x' +
										            '<a href="single-product.html?id=' + v.bookId + '">' + v.book.name + '</a>' +
										        '</p>' +
										        '<span class="cart-price">￥ ' + v.amount + '</span>' +
										    '</div>' +
										    '<div class="cart-product-remove" onClick="removeProduct(\'' + v.bookId +'\')">' +
										        '<i class="fa fa-times"></i>' +
										    '</div>' +
										'</div>';
								})
								$('#shopping-cart-num').append('<span>' + shopping_cart_num + '</span>')
								$('.shopping-cart-book-area').html(html)
								$('.total-amount').html('￥&nbsp;' + (total_amount / 10000))
							} else {
								layer.msg(resp.msg)
							}
						},
						error: function(e) {
							if (e.responseJSON != null) {
								layer.msg(e.responseJSON.msg)
							} else {
								layer.msg('服务器未启动')
							}
						}
					})
				}
			}
			
			/**
			 * 删除订单和tr，不刷新界面
			 */
			function removeTrAndProduct(_this) {
				layer.confirm('您确定要删除该订单吗？', {
					btn: ['确定', '取消'],
					yes: function(index) {
						layer.close(index)
						var tr = $(_this).parent().parent()
						var orderNo = $(tr).find('.orderNo').val()
						$(tr).remove()
						removeProduct(orderNo)
					}
				})
			}
			
			/**
			 * 移除购物车商品
			 */
			function removeProduct(orderNo) {
				$.ajax({
					url: url.order.del,
					headers: {
						token: userToken
					},
					data: JSON.stringify({
						orderNo: orderNo
					}),
					type: 'DELETE',
					dataType: 'json',
					contentType: 'application/json',
					success: function(resp) {
						if (resp.code != null && resp.code == 200) {
						} else {
							layer.msg(resp.msg)
						}
					},
					error: function(e) {
						if (e.responseJSON != null) {
							layer.msg(e.responseJSON.msg)
						} else {
							layer.msg('服务器未启动')
						}
					}
				})
			}
			
			/**
			 * 确认收货
			 */
			function receipt(_this) {
				var tr = $(_this).parents('tr')
				var orderNo = $(tr).find('.orderNo').val()
				$.ajax({
					url: url.order.receipt,
					data: JSON.stringify({
						orderNo: orderNo,
					}),
					headers: {token: userToken},
					type: 'PUT',
					dataType: 'json',
					contentType: 'application/json',
					success: function(resp) {
						if (resp.code != null && resp.code == 200) {
							$(tr).find('.td-status').html('已收货')
						} else {
							layer.msg(resp.msg)
						}
					},
					error: function(e) {
						if (e.responseJSON != null) {
							layer.msg(e.responseJSON.msg)
						} else {
							layer.msg('服务器未启动')
						}
					}
				})
			}
		</script>
</html>